'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.FormDefaultProps = undefined;

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

exports.default = Form;

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _utils = require('./utils');

var _utils2 = _interopRequireDefault(_utils);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var noop = function noop() {};
var reop = function reop(d) {
  return d;
};

var FormDefaultProps = exports.FormDefaultProps = {
  loadState: noop,
  defaultValues: {},
  preValidate: reop,
  validate: function validate() {
    return null;
  },
  onValidationFail: noop,
  onChange: noop,
  saveState: noop,
  willUnmount: noop,
  preSubmit: reop,
  onSubmit: noop,
  postSubmit: noop
};

function Form() {
  var config = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

  return function (Comp) {
    return _react2.default.createClass({
      childContextTypes: {
        formAPI: _react2.default.PropTypes.object
      },
      getChildContext: function getChildContext() {
        return {
          formAPI: this.getAPI()
        };
      },

      // Lifecycle
      getDefaultProps: function getDefaultProps() {
        return Object.assign({}, FormDefaultProps, config);
      },
      getInitialState: function getInitialState() {
        var values = Object.assign({}, _utils2.default.clone(config.defaultValues), _utils2.default.clone(this.props.values));
        return this.props.loadState(this.props) || {
          values: values,
          touched: {},
          errors: this.validate(values),
          nestedErrors: {}
        };
      },
      componentWillMount: function componentWillMount() {
        this.emitChange(this.state, true);
      },
      componentWillReceiveProps: function componentWillReceiveProps(props) {
        if (props.values === this.props.values) {
          return;
        }

        this.setFormState({
          values: _utils2.default.clone(props.values) || {}
        }, true);
      },
      componentWillUnmount: function componentWillUnmount() {
        this.props.willUnmount(this.state, this.props);
      },


      // API
      setValue: function setValue(field, value, noTouch) {
        var state = this.state;
        var values = _utils2.default.set(state.values, field, value);
        // Also set touched since the value is changing
        if (noTouch) {
          return this.setFormState({ values: values });
        }
        var touched = _utils2.default.set(state.touched, field, value);
        this.setFormState({ values: values, touched: touched });
      },
      getValue: function getValue(field, fallback) {
        var state = this.state;
        var val = _utils2.default.get(state.values, field);
        return typeof val !== 'undefined' ? val : fallback;
      },
      setNestedError: function setNestedError(field) {
        var value = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;

        var nestedErrors = _utils2.default.set(this.state.nestedErrors, field, value);
        this.setFormState({ nestedErrors: nestedErrors });
      },
      getError: function getError(field) {
        return _utils2.default.get(this.state.errors, field);
      },
      setTouched: function setTouched(field) {
        var value = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;

        var touched = _utils2.default.set(this.state.touched, field, value);
        this.setFormState({ touched: touched });
      },
      getTouched: function getTouched(field) {
        var state = this.state;
        if (this.state.dirty === true || this.props.touched === true) {
          return true;
        }
        return _utils2.default.get(state.touched, field);
      },
      addValue: function addValue(field, value) {
        var state = this.state;
        var values = _utils2.default.set(state.values, field, [].concat(_toConsumableArray(_utils2.default.get(state.values, field, [])), [value]));
        this.setFormState({ values: values });
      },
      removeValue: function removeValue(field, index) {
        var state = this.state;
        var fieldValue = _utils2.default.get(state.values, field, []);
        var values = _utils2.default.set(state.values, field, [].concat(_toConsumableArray(fieldValue.slice(0, index)), _toConsumableArray(fieldValue.slice(index + 1))));
        this.setFormState({ values: values });
      },
      swapValues: function swapValues(field, index, destIndex) {
        var state = this.state;
        var fieldValues = _utils2.default.get(state.values, field, []);
        var values = _utils2.default.set(state.values, field, [].concat(_toConsumableArray(fieldValues.slice(0, index)), [fieldValues[destIndex]], _toConsumableArray(fieldValues.slice(index + 1, destIndex)), [fieldValues[index]], _toConsumableArray(fieldValues.slice(destIndex + 1))));
        this.setFormState({ values: values });
      },
      setAllTouched: function setAllTouched() {
        var dirty = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;

        this.setFormState({ dirty: !!dirty });
      },
      submitForm: function submitForm(e) {
        e && e.preventDefault && e.preventDefault(e);
        var state = this.state;
        var errors = this.validate(state.values, state, this.props);
        if (errors) {
          if (!state.dirty) {
            this.setAllTouched();
          }
          return this.props.onValidationFail(state, this.props);
        }
        var preSubmitValues = this.props.preSubmit(state.values, state, this.props);
        this.props.onSubmit(preSubmitValues, state, this.props);
        this.props.postSubmit(preSubmitValues, state, this.props);
      },


      // Utils
      getAPI: function getAPI() {
        return {
          setValue: this.setValue,
          getValue: this.getValue,
          setNestedError: this.setNestedError,
          getError: this.getError,
          setTouched: this.setTouched,
          getTouched: this.getTouched,
          addValue: this.addValue,
          removeValue: this.removeValue,
          swapValues: this.swapValues,
          setAllTouched: this.setAllTouched,
          submitForm: this.submitForm
        };
      },
      setFormState: function setFormState(newState, silent) {
        var _this = this;

        if (newState && newState.values) {
          newState.values = this.props.preValidate(newState.values, newState, this.props);
          newState.errors = this.validate(newState.values, newState, this.props);
        }
        this.setState(newState, function () {
          _this.props.saveState(_this.state, _this.props);
          if (!silent) {
            _this.emitChange(_this.state, _this.props);
          }
        });
      },
      emitChange: function emitChange(state, initial) {
        this.props.onChange(state, this.props, initial);
      },
      validate: function validate(values) {
        var errors = this.props.validate(removeNestedErrorValues(values, this.state ? this.state.nestedErrors : {}));
        return cleanErrors(errors);
      },

      // Render
      render: function render() {
        var props = _extends({}, this.props, this.state, this.getAPI());
        return _react2.default.createElement(Comp, props);
      }
    });
  };
}

// Utils

function cleanErrors(err) {
  if (_utils2.default.isObject(err)) {
    var resolved = _utils2.default.mapValues(err, cleanErrors);
    var found = _utils2.default.pickBy(resolved, function (d) {
      return d;
    });
    return Object.keys(found).length ? resolved : undefined;
  }
  if (_utils2.default.isArray(err)) {
    var _resolved = err.map(cleanErrors);
    var _found = _resolved.find(function (d) {
      return d;
    });
    return _found ? _resolved : undefined;
  }
  return err;
}

function removeNestedErrorValues(value, nestedErrors) {
  var recurse = function recurse(value) {
    var path = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];

    if (_utils2.default.get(nestedErrors, path)) {
      return undefined;
    }
    if (_utils2.default.isObject(value)) {
      return _utils2.default.mapValues(value, function (d, i) {
        return recurse(d, [].concat(_toConsumableArray(path), [i]));
      });
    }
    if (_utils2.default.isArray(value)) {
      return value.map(function (d, key) {
        return recurse(d, [].concat(_toConsumableArray(path), [key]));
      });
    }
    return value;
  };
  return recurse(value);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9mb3JtLmpzIl0sIm5hbWVzIjpbIkZvcm0iLCJub29wIiwicmVvcCIsImQiLCJGb3JtRGVmYXVsdFByb3BzIiwibG9hZFN0YXRlIiwiZGVmYXVsdFZhbHVlcyIsInByZVZhbGlkYXRlIiwidmFsaWRhdGUiLCJvblZhbGlkYXRpb25GYWlsIiwib25DaGFuZ2UiLCJzYXZlU3RhdGUiLCJ3aWxsVW5tb3VudCIsInByZVN1Ym1pdCIsIm9uU3VibWl0IiwicG9zdFN1Ym1pdCIsImNvbmZpZyIsIkNvbXAiLCJjcmVhdGVDbGFzcyIsImNoaWxkQ29udGV4dFR5cGVzIiwiZm9ybUFQSSIsIlByb3BUeXBlcyIsIm9iamVjdCIsImdldENoaWxkQ29udGV4dCIsImdldEFQSSIsImdldERlZmF1bHRQcm9wcyIsIk9iamVjdCIsImFzc2lnbiIsImdldEluaXRpYWxTdGF0ZSIsInZhbHVlcyIsImNsb25lIiwicHJvcHMiLCJ0b3VjaGVkIiwiZXJyb3JzIiwibmVzdGVkRXJyb3JzIiwiY29tcG9uZW50V2lsbE1vdW50IiwiZW1pdENoYW5nZSIsInN0YXRlIiwiY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyIsInNldEZvcm1TdGF0ZSIsImNvbXBvbmVudFdpbGxVbm1vdW50Iiwic2V0VmFsdWUiLCJmaWVsZCIsInZhbHVlIiwibm9Ub3VjaCIsInNldCIsImdldFZhbHVlIiwiZmFsbGJhY2siLCJ2YWwiLCJnZXQiLCJzZXROZXN0ZWRFcnJvciIsImdldEVycm9yIiwic2V0VG91Y2hlZCIsImdldFRvdWNoZWQiLCJkaXJ0eSIsImFkZFZhbHVlIiwicmVtb3ZlVmFsdWUiLCJpbmRleCIsImZpZWxkVmFsdWUiLCJzbGljZSIsInN3YXBWYWx1ZXMiLCJkZXN0SW5kZXgiLCJmaWVsZFZhbHVlcyIsInNldEFsbFRvdWNoZWQiLCJzdWJtaXRGb3JtIiwiZSIsInByZXZlbnREZWZhdWx0IiwicHJlU3VibWl0VmFsdWVzIiwibmV3U3RhdGUiLCJzaWxlbnQiLCJzZXRTdGF0ZSIsImluaXRpYWwiLCJyZW1vdmVOZXN0ZWRFcnJvclZhbHVlcyIsImNsZWFuRXJyb3JzIiwicmVuZGVyIiwiZXJyIiwiaXNPYmplY3QiLCJyZXNvbHZlZCIsIm1hcFZhbHVlcyIsImZvdW5kIiwicGlja0J5Iiwia2V5cyIsImxlbmd0aCIsInVuZGVmaW5lZCIsImlzQXJyYXkiLCJtYXAiLCJmaW5kIiwicmVjdXJzZSIsInBhdGgiLCJpIiwia2V5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7a0JBb0J3QkEsSTs7QUFwQnhCOzs7O0FBQ0E7Ozs7Ozs7O0FBRUEsSUFBTUMsT0FBTyxTQUFQQSxJQUFPLEdBQU0sQ0FBRSxDQUFyQjtBQUNBLElBQU1DLE9BQU8sU0FBUEEsSUFBTztBQUFBLFNBQUtDLENBQUw7QUFBQSxDQUFiOztBQUVPLElBQU1DLDhDQUFtQjtBQUM5QkMsYUFBV0osSUFEbUI7QUFFOUJLLGlCQUFlLEVBRmU7QUFHOUJDLGVBQWFMLElBSGlCO0FBSTlCTSxZQUFVO0FBQUEsV0FBTSxJQUFOO0FBQUEsR0FKb0I7QUFLOUJDLG9CQUFrQlIsSUFMWTtBQU05QlMsWUFBVVQsSUFOb0I7QUFPOUJVLGFBQVdWLElBUG1CO0FBUTlCVyxlQUFhWCxJQVJpQjtBQVM5QlksYUFBV1gsSUFUbUI7QUFVOUJZLFlBQVViLElBVm9CO0FBVzlCYyxjQUFZZDtBQVhrQixDQUF6Qjs7QUFjUSxTQUFTRCxJQUFULEdBQTRCO0FBQUEsTUFBYmdCLE1BQWEsdUVBQUosRUFBSTs7QUFDekMsU0FBTyxVQUFDQyxJQUFELEVBQVU7QUFDZixXQUFPLGdCQUFNQyxXQUFOLENBQWtCO0FBQ3ZCQyx5QkFBbUI7QUFDakJDLGlCQUFTLGdCQUFNQyxTQUFOLENBQWdCQztBQURSLE9BREk7QUFJdkJDLHFCQUp1Qiw2QkFJSjtBQUNqQixlQUFPO0FBQ0xILG1CQUFTLEtBQUtJLE1BQUw7QUFESixTQUFQO0FBR0QsT0FSc0I7O0FBU3ZCO0FBQ0FDLHFCQVZ1Qiw2QkFVSjtBQUNqQixlQUFPQyxPQUFPQyxNQUFQLENBQWMsRUFBZCxFQUFr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QVYsQ0FBSixFQUFzQjtBQUNwQixhQUFPQSxNQUFNMEMsR0FBTixDQUFVLFVBQUNsRixDQUFELEVBQUl1RixHQUFKLEVBQVk7QUFDM0IsZUFBT0gsUUFBUXBGLENBQVIsK0JBQWVxRixJQUFmLElBQXFCRSxHQUFyQixHQUFQO0FBQ0QsT0FGTSxDQUFQO0FBR0Q7QUFDRCxXQUFPL0MsS0FBUDtBQUNELEdBZkQ7QUFnQkEsU0FBTzRDLFFBQVE1QyxLQUFSLENBQVA7QUFDRCIsImZpbGUiOiJmb3JtLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0J1xuaW1wb3J0IF8gZnJvbSAnLi91dGlscydcblxuY29uc3Qgbm9vcCA9ICgpID0+IHt9XG5jb25zdCByZW9wID0gZCA9PiBkXG5cbmV4cG9ydCBjb25zdCBGb3JtRGVmYXVsdFByb3BzID0ge1xuICBsb2FkU3RhdGU6IG5vb3AsXG4gIGRlZmF1bHRWYWx1ZXM6IHt9LFxuICBwcmVWYWxpZGF0ZTogcmVvcCxcbiAgdmFsaWRhdGU6ICgpID0+IG51bGwsXG4gIG9uVmFsaWRhdGlvbkZhaWw6IG5vb3AsXG4gIG9uQ2hhbmdlOiBub29wLFxuICBzYXZlU3RhdGU6IG5vb3AsXG4gIHdpbGxVbm1vdW50OiBub29wLFxuICBwcmVTdWJtaXQ6IHJlb3AsXG4gIG9uU3VibWl0OiBub29wLFxuICBwb3N0U3VibWl0OiBub29wXG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIEZvcm0gKGNvbmZpZyA9IHt9KSB7XG4gIHJldHVybiAoQ29tcCkgPT4ge1xuICAgIHJldHVybiBSZWFjdC5jcmVhdGVDbGFzcyh7XG4gICAgICBjaGlsZENvbnRleHRUeXBlczoge1xuICAgICAgICBmb3JtQVBJOiBSZWFjdC5Qcm9wVHlwZXMub2JqZWN0XG4gICAgICB9LFxuICAgICAgZ2V0Q2hpbGRDb250ZXh0ICgpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBmb3JtQVBJOiB0aGlzLmdldEFQSSgpXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICAvLyBMaWZlY3ljbGVcbiAgICAgIGdldERlZmF1bHRQcm9wcyAoKSB7XG4gICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBGb3JtRGVmYXVsdFByb3BzLCBjb25maWcpXG4gICAgICB9LFxuICAgICAgZ2V0SW5pdGlhbFN0YXRlICgpIHtcbiAgICAgICAgY29uc3QgdmFsdWVzID0gT2JqZWN0LmFzc2lnbih7fSwgXy5jbG9uZShjb25maWcuZGVmYXVsdFZhbHVlcyksIF8uY2xvbmUodGhpcy5wcm9wcy52YWx1ZXMpKVxuICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy5sb2FkU3RhdGUodGhpcy5wcm9wcykgfHwge1xuICAgICAgICAgIHZhbHVlcyxcbiAgICAgICAgICB0b3VjaGVkOiB7fSxcbiAgICAgICAgICBlcnJvcnM6IHRoaXMudmFsaWRhdGUodmFsdWVzKSxcbiAgICAgICAgICBuZXN0ZWRFcnJvcnM6IHt9XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBjb21wb25lbnRXaWxsTW91bnQgKCkge1xuICAgICAgICB0aGlzLmVtaXRDaGFuZ2UodGhpcy5zdGF0ZSwgdHJ1ZSlcbiAgICAgIH0sXG4gICAgICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIChwcm9wcykge1xuICAgICAgICBpZiAocHJvcHMudmFsdWVzID09PSB0aGlzLnByb3BzLnZhbHVlcykge1xuICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXRGb3JtU3RhdGUoe1xuICAgICAgICAgIHZhbHVlczogXy5jbG9uZShwcm9wcy52YWx1ZXMpIHx8IHt9XG4gICAgICAgIH0sIHRydWUpXG4gICAgICB9LFxuICAgICAgY29tcG9uZW50V2lsbFVubW91bnQgKCkge1xuICAgICAgICB0aGlzLnByb3BzLndpbGxVbm1vdW50KHRoaXMuc3RhdGUsIHRoaXMucHJvcHMpXG4gICAgICB9LFxuXG4gICAgICAvLyBBUElcbiAgICAgIHNldFZhbHVlIChmaWVsZCwgdmFsdWUsIG5vVG91Y2gpIHtcbiAgICAgICAgY29uc3Qgc3RhdGUgPSB0aGlzLnN0YXRlXG4gICAgICAgIGNvbnN0IHZhbHVlcyA9IF8uc2V0KHN0YXRlLnZhbHVlcywgZmllbGQsIHZhbHVlKVxuICAgICAgICAvLyBBbHNvIHNldCB0b3VjaGVkIHNpbmNlIHRoZSB2YWx1ZSBpcyBjaGFuZ2luZ1xuICAgICAgICBpZiAobm9Ub3VjaCkge1xuICAgICAgICAgIHJldHVybiB0aGlzLnNldEZvcm1TdGF0ZSh7dmFsdWVzfSlcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB0b3VjaGVkID0gXy5zZXQoc3RhdGUudG91Y2hlZCwgZmllbGQsIHZhbHVlKVxuICAgICAgICB0aGlzLnNldEZvcm1TdGF0ZSh7dmFsdWVzLCB0b3VjaGVkfSlcbiAgICAgIH0sXG4gICAgICBnZXRWYWx1ZSAoZmllbGQsIGZhbGxiYWNrKSB7XG4gICAgICAgIGNvbnN0IHN0YXRlID0gdGhpcy5zdGF0ZVxuICAgICAgICBjb25zdCB2YWwgPSBfLmdldChzdGF0ZS52YWx1ZXMsIGZpZWxkKVxuICAgICAgICByZXR1cm4gdHlwZW9mIHZhbCAhPT0gJ3VuZGVmaW5lZCcgPyB2YWwgOiBmYWxsYmFja1xuICAgICAgfSxcbiAgICAgIHNldE5lc3RlZEVycm9yIChmaWVsZCwgdmFsdWUgPSB0cnVlKSB7XG4gICAgICAgIGNvbnN0IG5lc3RlZEVycm9ycyA9IF8uc2V0KHRoaXMuc3RhdGUubmVzdGVkRXJyb3JzLCBmaWVsZCwgdmFsdWUpXG4gICAgICAgIHRoaXMuc2V0Rm9ybVN0YXRlKHtuZXN0ZWRFcnJvcnN9KVxuICAgICAgfSxcbiAgICAgIGdldEVycm9yIChmaWVsZCkge1xuICAgICAgICByZXR1cm4gXy5nZXQodGhpcy5zdGF0ZS5lcnJvcnMsIGZpZWxkKVxuICAgICAgfSxcbiAgICAgIHNldFRvdWNoZWQgKGZpZWxkLCB2YWx1ZSA9IHRydWUpIHtcbiAgICAgICAgY29uc3QgdG91Y2hlZCA9IF8uc2V0KHRoaXMuc3RhdGUudG91Y2hlZCwgZmllbGQsIHZhbHVlKVxuICAgICAgICB0aGlzLnNldEZvcm1TdGF0ZSh7dG91Y2hlZH0pXG4gICAgICB9LFxuICAgICAgZ2V0VG91Y2hlZCAoZmllbGQpIHtcbiAgICAgICAgY29uc3Qgc3RhdGUgPSB0aGlzLnN0YXRlXG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmRpcnR5ID09PSB0cnVlIHx8IHRoaXMucHJvcHMudG91Y2hlZCA9PT0gdHJ1ZSkge1xuICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIF8uZ2V0KHN0YXRlLnRvdWNoZWQsIGZpZWxkKVxuICAgICAgfSxcbiAgICAgIGFkZFZhbHVlIChmaWVsZCwgdmFsdWUpIHtcbiAgICAgICAgY29uc3Qgc3RhdGUgPSB0aGlzLnN0YXRlXG4gICAgICAgIGNvbnN0IHZhbHVlcyA9IF8uc2V0KHN0YXRlLnZhbHVlcywgZmllbGQsIFtcbiAgICAgICAgICAuLi5fLmdldChzdGF0ZS52YWx1ZXMsIGZpZWxkLCBbXSksXG4gICAgICAgICAgdmFsdWVcbiAgICAgICAgXSlcbiAgICAgICAgdGhpcy5zZXRGb3JtU3RhdGUoe3ZhbHVlc30pXG4gICAgICB9LFxuICAgICAgcmVtb3ZlVmFsdWUgKGZpZWxkLCBpbmRleCkge1xuICAgICAgICBjb25zdCBzdGF0ZSA9IHRoaXMuc3RhdGVcbiAgICAgICAgY29uc3QgZmllbGRWYWx1ZSA9IF8uZ2V0KHN0YXRlLnZhbHVlcywgZmllbGQsIFtdKVxuICAgICAgICBjb25zdCB2YWx1ZXMgPSBfLnNldChzdGF0ZS52YWx1ZXMsIGZpZWxkLCBbXG4gICAgICAgICAgLi4uZmllbGRWYWx1ZS5zbGljZSgwLCBpbmRleCksXG4gICAgICAgICAgLi4uZmllbGRWYWx1ZS5zbGljZShpbmRleCArIDEpXG4gICAgICAgIF0pXG4gICAgICAgIHRoaXMuc2V0Rm9ybVN0YXRlKHt2YWx1ZXN9KVxuICAgICAgfSxcbiAgICAgIHN3YXBWYWx1ZXMgKGZpZWxkLCBpbmRleCwgZGVzdEluZGV4KSB7XG4gICAgICAgIGNvbnN0IHN0YXRlID0gdGhpcy5zdGF0ZVxuICAgICAgICBjb25zdCBmaWVsZFZhbHVlcyA9IF8uZ2V0KHN0YXRlLnZhbHVlcywgZmllbGQsIFtdKVxuICAgICAgICBjb25zdCB2YWx1ZXMgPSBfLnNldChzdGF0ZS52YWx1ZXMsIGZpZWxkLCBbXG4gICAgICAgICAgLi4uZmllbGRWYWx1ZXMuc2xpY2UoMCwgaW5kZXgpLFxuICAgICAgICAgIGZpZWxkVmFsdWVzW2Rlc3RJbmRleF0sXG4gICAgICAgICAgLi4uZmllbGRWYWx1ZXMuc2xpY2UoaW5kZXggKyAxLCBkZXN0SW5kZXgpLFxuICAgICAgICAgIGZpZWxkVmFsdWVzW2luZGV4XSxcbiAgICAgICAgICAuLi5maWVsZFZhbHVlcy5zbGljZShkZXN0SW5kZXggKyAxKVxuICAgICAgICBdKVxuICAgICAgICB0aGlzLnNldEZvcm1TdGF0ZSh7dmFsdWVzfSlcbiAgICAgIH0sXG4gICAgICBzZXRBbGxUb3VjaGVkIChkaXJ0eSA9IHRydWUpIHtcbiAgICAgICAgdGhpcy5zZXRGb3JtU3RhdGUoe2RpcnR5OiAhIWRpcnR5fSlcbiAgICAgIH0sXG4gICAgICBzdWJtaXRGb3JtIChlKSB7XG4gICAgICAgIGUgJiYgZS5wcmV2ZW50RGVmYXVsdCAmJiBlLnByZXZlbnREZWZhdWx0KGUpXG4gICAgICAgIGNvbnN0IHN0YXRlID0gdGhpcy5zdGF0ZVxuICAgICAgICBjb25zdCBlcnJvcnMgPSB0aGlzLnZhbGlkYXRlKHN0YXRlLnZhbHVlcywgc3RhdGUsIHRoaXMucHJvcHMpXG4gICAgICAgIGlmIChlcnJvcnMpIHtcbiAgICAgICAgICBpZiAoIXN0YXRlLmRpcnR5KSB7XG4gICAgICAgICAgICB0aGlzLnNldEFsbFRvdWNoZWQoKVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy5vblZhbGlkYXRpb25GYWlsKHN0YXRlLCB0aGlzLnByb3BzKVxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHByZVN1Ym1pdFZhbHVlcyA9IHRoaXMucHJvcHMucHJlU3VibWl0KHN0YXRlLnZhbHVlcywgc3RhdGUsIHRoaXMucHJvcHMpXG4gICAgICAgIHRoaXMucHJvcHMub25TdWJtaXQocHJlU3VibWl0VmFsdWVzLCBzdGF0ZSwgdGhpcy5wcm9wcylcbiAgICAgICAgdGhpcy5wcm9wcy5wb3N0U3VibWl0KHByZVN1Ym1pdFZhbHVlcywgc3RhdGUsIHRoaXMucHJvcHMpXG4gICAgICB9LFxuXG4gICAgICAvLyBVdGlsc1xuICAgICAgZ2V0QVBJICgpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzZXRWYWx1ZTogdGhpcy5zZXRWYWx1ZSxcbiAgICAgICAgICBnZXRWYWx1ZTogdGhpcy5nZXRWYWx1ZSxcbiAgICAgICAgICBzZXROZXN0ZWRFcnJvcjogdGhpcy5zZXROZXN0ZWRFcnJvcixcbiAgICAgICAgICBnZXRFcnJvcjogdGhpcy5nZXRFcnJvcixcbiAgICAgICAgICBzZXRUb3VjaGVkOiB0aGlzLnNldFRvdWNoZWQsXG4gICAgICAgICAgZ2V0VG91Y2hlZDogdGhpcy5nZXRUb3VjaGVkLFxuICAgICAgICAgIGFkZFZhbHVlOiB0aGlzLmFkZFZhbHVlLFxuICAgICAgICAgIHJlbW92ZVZhbHVlOiB0aGlzLnJlbW92ZVZhbHVlLFxuICAgICAgICAgIHN3YXBWYWx1ZXM6IHRoaXMuc3dhcFZhbHVlcyxcbiAgICAgICAgICBzZXRBbGxUb3VjaGVkOiB0aGlzLnNldEFsbFRvdWNoZWQsXG4gICAgICAgICAgc3VibWl0Rm9ybTogdGhpcy5zdWJtaXRGb3JtXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBzZXRGb3JtU3RhdGUgKG5ld1N0YXRlLCBzaWxlbnQpIHtcbiAgICAgICAgaWYgKG5ld1N0YXRlICYmIG5ld1N0YXRlLnZhbHVlcykge1xuICAgICAgICAgIG5ld1N0YXRlLnZhbHVlcyA9IHRoaXMucHJvcHMucHJlVmFsaWRhdGUobmV3U3RhdGUudmFsdWVzLCBuZXdTdGF0ZSwgdGhpcy5wcm9wcylcbiAgICAgICAgICBuZXdTdGF0ZS5lcnJvcnMgPSB0aGlzLnZhbGlkYXRlKG5ld1N0YXRlLnZhbHVlcywgbmV3U3RhdGUsIHRoaXMucHJvcHMpXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXRTdGF0ZShuZXdTdGF0ZSwgKCkgPT4ge1xuICAgICAgICAgIHRoaXMucHJvcHMuc2F2ZVN0YXRlKHRoaXMuc3RhdGUsIHRoaXMucHJvcHMpXG4gICAgICAgICAgaWYgKCFzaWxlbnQpIHtcbiAgICAgICAgICAgIHRoaXMuZW1pdENoYW5nZSh0aGlzLnN0YXRlLCB0aGlzLnByb3BzKVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH0sXG4gICAgICBlbWl0Q2hhbmdlIChzdGF0ZSwgaW5pdGlhbCkge1xuICAgICAgICB0aGlzLnByb3BzLm9uQ2hhbmdlKHN0YXRlLCB0aGlzLnByb3BzLCBpbml0aWFsKVxuICAgICAgfSxcbiAgICAgIHZhbGlkYXRlICh2YWx1ZXMpIHtcbiAgICAgICAgY29uc3QgZXJyb3JzID0gdGhpcy5wcm9wcy52YWxpZGF0ZShcbiAgICAgICAgICByZW1vdmVOZXN0ZWRFcnJvclZhbHVlcyh2YWx1ZXMsIHRoaXMuc3RhdGUgPyB0aGlzLnN0YXRlLm5lc3RlZEVycm9ycyA6IHt9KVxuICAgICAgICApXG4gICAgICAgIHJldHVybiBjbGVhbkVycm9ycyhlcnJvcnMpXG4gICAgICB9LFxuICAgICAgLy8gUmVuZGVyXG4gICAgICByZW5kZXIgKCkge1xuICAgICAgICBjb25zdCBwcm9wcyA9IHtcbiAgICAgICAgICAuLi50aGlzLnByb3BzLFxuICAgICAgICAgIC4uLnRoaXMuc3RhdGUsXG4gICAgICAgICAgLi4udGhpcy5nZXRBUEkoKVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgPENvbXAgey4uLnByb3BzfSAvPlxuICAgICAgICApXG4gICAgICB9XG4gICAgfSlcbiAgfVxufVxuXG4vLyBVdGlsc1xuXG5mdW5jdGlvbiBjbGVhbkVycm9ycyAoZXJyKSB7XG4gIGlmIChfLmlzT2JqZWN0KGVycikpIHtcbiAgICBjb25zdCByZXNvbHZlZCA9IF8ubWFwVmFsdWVzKGVyciwgY2xlYW5FcnJvcnMpXG4gICAgY29uc3QgZm91bmQgPSBfLnBpY2tCeShyZXNvbHZlZCwgZCA9PiBkKVxuICAgIHJldHVybiBPYmplY3Qua2V5cyhmb3VuZCkubGVuZ3RoID8gcmVzb2x2ZWQgOiB1bmRlZmluZWRcbiAgfVxuICBpZiAoXy5pc0FycmF5KGVycikpIHtcbiAgICBjb25zdCByZXNvbHZlZCA9IGVyci5tYXAoY2xlYW5FcnJvcnMpXG4gICAgY29uc3QgZm91bmQgPSByZXNvbHZlZC5maW5kKGQgPT4gZClcbiAgICByZXR1cm4gZm91bmQgPyByZXNvbHZlZCA6IHVuZGVmaW5lZFxuICB9XG4gIHJldHVybiBlcnJcbn1cblxuZnVuY3Rpb24gcmVtb3ZlTmVzdGVkRXJyb3JWYWx1ZXMgKHZhbHVlLCBuZXN0ZWRFcnJvcnMpIHtcbiAgY29uc3QgcmVjdXJzZSA9ICh2YWx1ZSwgcGF0aCA9IFtdKSA9PiB7XG4gICAgaWYgKF8uZ2V0KG5lc3RlZEVycm9ycywgcGF0aCkpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICB9XG4gICAgaWYgKF8uaXNPYmplY3QodmFsdWUpKSB7XG4gICAgICByZXR1cm4gXy5tYXBWYWx1ZXModmFsdWUsIChkLCBpKSA9PiB7XG4gICAgICAgIHJldHVybiByZWN1cnNlKGQsIFsuLi5wYXRoLCBpXSlcbiAgICAgIH0pXG4gICAgfVxuICAgIGlmIChfLmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICByZXR1cm4gdmFsdWUubWFwKChkLCBrZXkpID0+IHtcbiAgICAgICAgcmV0dXJuIHJlY3Vyc2UoZCwgWy4uLnBhdGgsIGtleV0pXG4gICAgICB9KVxuICAgIH1cbiAgICByZXR1cm4gdmFsdWVcbiAgfVxuICByZXR1cm4gcmVjdXJzZSh2YWx1ZSlcbn1cbiJdfQ==